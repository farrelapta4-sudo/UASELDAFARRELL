<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM-004T MQTT Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --neon-green: #00ff41;
            --neon-blue: #00d2ff;
            --neon-red: #ff3131;
            --neon-yellow: #ffde00;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        h1 { margin: 0; letter-spacing: 2px; }
        
        #status {
            font-size: 0.9rem;
            margin-top: 5px;
            color: #888;
        }
        
        .status-dot {
            height: 10px;
            width: 10px;
            background-color: red;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        /* Grid Layout untuk Kartu Nilai */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }

        .card h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #aaa;
            text-transform: uppercase;
        }

        /* Gaya Tampilan Digital / 7-Segment */
        .digital-value {
            font-family: 'Orbitron', sans-serif; /* Font Digital */
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2); /* Efek Glow */
        }

        .unit {
            font-size: 1rem;
            color: #777;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Warna spesifik untuk tiap parameter */
        .val-voltage { color: var(--neon-yellow); text-shadow: 0 0 10px var(--neon-yellow); }
        .val-current { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }
        .val-power { color: var(--neon-red); text-shadow: 0 0 10px var(--neon-red); }
        .val-energy { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }

        /* Area Grafik */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-wrapper {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>

    <header>
        <h1>MONITORING LISTRIK (PZEM-004T)</h1>
        <div id="status"><span class="status-dot" id="statusDot"></span>Status: <span id="statusText">Disconnected</span></div>
    </header>

    <div class="grid-container">
        <div class="card">
            <h3>Tegangan</h3>
            <div class="digital-value val-voltage" id="disp-voltage">0.0</div>
            <span class="unit">Volt (V)</span>
        </div>
        <div class="card">
            <h3>Arus</h3>
            <div class="digital-value val-current" id="disp-current">0.000</div>
            <span class="unit">Ampere (A)</span>
        </div>
        <div class="card">
            <h3>Daya Aktif</h3>
            <div class="digital-value val-power" id="disp-power">0.0</div>
            <span class="unit">Watt (W)</span>
        </div>
        <div class="card">
            <h3>Total Energi</h3>
            <div class="digital-value val-energy" id="disp-energy">0.00</div>
            <span class="unit">kWh</span>
        </div>
        <div class="card">
            <h3>Frekuensi</h3>
            <div class="digital-value" id="disp-freq" style="color: #fff;">0.0</div>
            <span class="unit">Hz</span>
        </div>
        <div class="card">
            <h3>Power Factor</h3>
            <div class="digital-value" id="disp-pf" style="color: #fff;">0.00</div>
            <span class="unit">PF</span>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-wrapper">
            <canvas id="chartPower"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="chartVoltage"></canvas>
        </div>
    </div>

    <script>
        // --- KONFIGURASI MQTT ---
        // PENTING: Untuk GitHub Pages (HTTPS), kita harus pakai WSS (Secure WebSocket).
        // Broker EMQX mendukung WSS di port 1883.
        const mqtt_broker = "broker.emqx.io";
        const mqtt_port = 1883; 
        const mqtt_topic = "iot/pzem/data";
        const client_id = "web_dashboard_" + Math.random().toString(16).substr(2, 8);

        // --- INISIALISASI CHART.JS ---
        const maxDataPoints = 20; // Jumlah data maksimal di grafik agar tidak menumpuk

        // Grafik Daya (Watt)
        const ctxPower = document.getElementById('chartPower').getContext('2d');
        const chartPower = new Chart(ctxPower, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Daya (Watt)',
                    data: [],
                    borderColor: '#ff3131',
                    backgroundColor: 'rgba(255, 49, 49, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4 // Garis melengkung
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { ticks: { color: '#888' }, grid: { color: '#333' } },
                    y: { ticks: { color: '#888' }, grid: { color: '#333' }, beginAtZero: true }
                },
                plugins: { legend: { labels: { color: '#fff' } } }
            }
        });

        // Grafik Tegangan (Volt)
        const ctxVolt = document.getElementById('chartVoltage').getContext('2d');
        const chartVoltage = new Chart(ctxVolt, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Tegangan (Volt)',
                    data: [],
                    borderColor: '#ffde00',
                    borderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { ticks: { color: '#888' }, grid: { color: '#333' } },
                    y: { ticks: { color: '#888' }, grid: { color: '#333' }, suggestedMin: 200, suggestedMax: 240 }
                },
                plugins: { legend: { labels: { color: '#fff' } } }
            }
        });

        // --- LOGIKA MQTT ---
        const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, client_id);

        // Callback ketika koneksi hilang
        client.onConnectionLost = function (responseObject) {
            console.log("Koneksi Hilang: " + responseObject.errorMessage);
            document.getElementById("statusText").innerText = "Disconnected";
            document.getElementById("statusDot").style.backgroundColor = "red";
            // Coba konek lagi setelah 5 detik
            setTimeout(connectMQTT, 5000);
        };

        // Callback ketika pesan masuk
        client.onMessageArrived = function (message) {
            console.log("Data Masuk: " + message.payloadString);
            
            try {
                const data = JSON.parse(message.payloadString);

                // 1. Update Angka Digital
                document.getElementById('disp-voltage').innerText = data.tegangan.toFixed(1);
                document.getElementById('disp-current').innerText = data.arus.toFixed(3);
                document.getElementById('disp-power').innerText = data.daya.toFixed(1);
                document.getElementById('disp-energy').innerText = data.energi.toFixed(2);
                document.getElementById('disp-freq').innerText = data.frekuensi.toFixed(1);
                document.getElementById('disp-pf').innerText = data.pf.toFixed(2);

                // 2. Update Grafik
                updateChart(chartPower, data.daya);
                updateChart(chartVoltage, data.tegangan);

            } catch (e) {
                console.error("Error parsing JSON: ", e);
            }
        };

        // Fungsi Update Grafik agar bergerak (scrolling)
        function updateChart(chart, value) {
            const now = new Date();
            const timeLabel = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();

            chart.data.labels.push(timeLabel);
            chart.data.datasets.forEach((dataset) => {
                dataset.data.push(value);
            });

            // Hapus data lama jika melebihi batas
            if (chart.data.labels.length > maxDataPoints) {
                chart.data.labels.shift();
                chart.data.datasets.forEach((dataset) => {
                    dataset.data.shift();
                });
            }
            chart.update();
        }

        // Fungsi Koneksi
        function connectMQTT() {
            document.getElementById("statusText").innerText = "Connecting...";
            client.connect({
                onSuccess: function () {
                    console.log("Berhasil Konek ke Broker!");
                    document.getElementById("statusText").innerText = "Connected (Live)";
                    document.getElementById("statusDot").style.backgroundColor = "#00ff41";
                    client.subscribe(mqtt_topic);
                },
                onFailure: function (e) {
                    console.log("Gagal Konek: " + e.errorMessage);
                    document.getElementById("statusText").innerText = "Error";
                    setTimeout(connectMQTT, 5000);
                },
                useSSL: true // Wajib True untuk GitHub Pages
            });
        }

        // Mulai Koneksi saat halaman dimuat
        connectMQTT();

    </script>
</body>
</html>
